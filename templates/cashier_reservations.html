{% extends "base.html" %}

{% block title %}Cashier - Reservations{% endblock %}

{% block styles %}
<style>
  * {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
  }

  body {
    background: #f5f7fa;
    color: #333;
  }

  .container {
    max-width: 1400px;
    margin: 0 auto;
    padding: 20px;
  }

  header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 24px;
    padding-bottom: 18px;
    border-bottom: 2px solid #ddd;
  }

  h1 {
    font-size: 26px;
    color: #222;
  }

  .btn {
    padding: 9px 16px;
    border: 1px solid #ddd;
    border-radius: 8px;
    background: #f8f8f8;
    color: #222;
    cursor: pointer;
    text-decoration: none;
    display: inline-block;
    font-size: 13.5px;
    font-weight: 500;
    transition: background 0.15s;
  }

  .btn:hover {
    background: #efefef;
  }

  .card {
    background: white;
    border-radius: 12px;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
    padding: 20px;
    margin-bottom: 20px;
  }

  /* Stats */
  .stats {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
    gap: 12px;
    margin-bottom: 20px;
  }

  .stat-box {
    background: white;
    border-radius: 8px;
    padding: 16px;
    text-align: center;
    border-left: 4px solid #007bff;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.04);
  }

  .stat-box .num {
    font-size: 26px;
    font-weight: 700;
    color: #222;
  }

  .stat-box .lbl {
    font-size: 12px;
    color: #999;
    margin-top: 4px;
  }

  /* Filter bar */
  .filter-bar {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
    gap: 14px;
    margin-bottom: 20px;
  }

  .filter-group {
    display: flex;
    flex-direction: column;
    gap: 5px;
  }

  .filter-group label {
    font-weight: 600;
    color: #555;
    font-size: 13px;
  }

  .filter-group select,
  .filter-group input {
    padding: 9px 12px;
    border: 1px solid #ddd;
    border-radius: 8px;
    background: white;
    font-size: 13.5px;
    color: #333;
  }

  /* Table */
  table {
    border-collapse: collapse;
    width: 100%;
    font-size: 14px;
  }

  thead {
    background: #f8f9fa;
    border-bottom: 2px solid #ddd;
  }

  th {
    padding: 11px 14px;
    text-align: left;
    font-weight: 600;
    color: #555;
    font-size: 12px;
    text-transform: uppercase;
    letter-spacing: 0.04em;
  }

  td {
    padding: 12px 14px;
    border-bottom: 1px solid #eee;
    vertical-align: middle;
  }

  tbody tr:hover {
    background: #f9f9f9;
  }

  tbody tr.hidden {
    display: none;
  }

  .parent-row {
    background: #fef9f3;
  }

  .student-row {
    background: #f0f8ff;
  }

  /* Badges */
  .status-badge {
    display: inline-block;
    padding: 4px 12px;
    border-radius: 20px;
    font-size: 11px;
    font-weight: 700;
    white-space: nowrap;
  }

  .status-reserved {
    background: #fff3cd;
    color: #856404;
    border: 1px solid #ffeaa7;
  }

  .status-paid {
    background: #cfe2ff;
    color: #084298;
    border: 1px solid #b6d4fe;
  }

  .status-claimed {
    background: #d1e7dd;
    color: #0f5132;
    border: 1px solid #badbcc;
  }

  .status-cancelled {
    background: #f8d7da;
    color: #842029;
    border: 1px solid #f5c2c7;
  }

  .badge-parent {
    display: inline-block;
    padding: 3px 8px;
    border-radius: 10px;
    font-size: 10px;
    font-weight: 700;
    background: #f3e5f5;
    color: #7b1fa2;
    border: 1px solid #ce93d8;
    margin-left: 4px;
    white-space: nowrap;
  }

  .action-link {
    color: #2563eb;
    text-decoration: none;
    font-weight: 600;
    padding: 5px 10px;
    border-radius: 6px;
    transition: background 0.15s;
    white-space: nowrap;
  }

  .action-link:hover {
    background: #eff6ff;
  }

  .student-sub {
    font-size: 11px;
    color: #999;
    margin-top: 2px;
  }

  .empty-state {
    text-align: center;
    padding: 48px 20px;
    color: #999;
  }

  .empty-icon {
    font-size: 44px;
    margin-bottom: 10px;
  }

  #noFilterResults {
    text-align: center;
    padding: 30px;
    color: #999;
    display: none;
  }
</style>
{% endblock %}

{% block content %}
<div class="container">
  <header>
    <h1>üìã Reservations</h1>
    <a href="{{ url_for('cashier.dashboard') }}" class="btn">‚¨Ö Back</a>
  </header>

  {% if rows and rows|length > 0 %}

  <!-- Stats -->
  <div class="stats">
    <div class="stat-box">
      <div class="num">{{ rows|length }}</div>
      <div class="lbl">Total</div>
    </div>
    <div class="stat-box" style="border-left-color:#ffc107;">
      <div class="num">{{ rows|selectattr(7, 'equalto', 'RESERVED')|list|length }}</div>
      <div class="lbl">Reserved</div>
    </div>
    <div class="stat-box" style="border-left-color:#17a2b8;">
      <div class="num">{{ rows|selectattr(7, 'equalto', 'PAID')|list|length }}</div>
      <div class="lbl">Paid</div>
    </div>
    <div class="stat-box" style="border-left-color:#28a745;">
      <div class="num">{{ rows|selectattr(7, 'equalto', 'CLAIMED')|list|length }}</div>
      <div class="lbl">Claimed</div>
    </div>
  </div>

  <!-- Filters (client-side) -->
  <div class="card filter-bar">
    <div class="filter-group">
      <label>üë§ Reserved By</label>
      <select id="fUserType" onchange="applyFilters()">
        <option value="">All (Students &amp; Parents)</option>
        <option value="student">üë®‚Äçüéì Students Only</option>
        <option value="parent">üë®‚Äçüë©‚Äçüëß Parents Only</option>
      </select>
    </div>
    <div class="filter-group">
      <label>üìä Status</label>
      <select id="fStatus" onchange="applyFilters()">
        <option value="">All statuses</option>
        <option value="RESERVED">Reserved</option>
        <option value="PAID">Paid</option>
        <option value="CLAIMED">Claimed</option>
        <option value="CANCELLED">Cancelled</option>
      </select>
    </div>
    <div class="filter-group">
      <label>üéì Grade Level</label>
      <select id="fGrade" onchange="applyFilters()">
        <option value="">All grades</option>
        <option value="Nursery">Nursery</option>
        <option value="Kinder">Kinder</option>
        {% for i in range(1, 13) %}
        <option value="Grade {{ i }}">Grade {{ i }}</option>
        {% endfor %}
      </select>
    </div>
    <div class="filter-group">
      <label>üîç Search Name</label>
      <input type="text" id="fSearch" placeholder="Student name..." oninput="applyFilters()">
    </div>
  </div>

  <!-- Table -->
  <div class="card">
    <table id="resTable">
      <thead>
        <tr>
          <th>#</th>
          <th>Student</th>
          <th>Grade</th>
          <th>Reserved By</th>
          <th>Status</th>
          <th>Date</th>
          <th>Action</th>
        </tr>
      </thead>
      <tbody id="resBody">
        {% for r in rows %}
        {#
        r[0]=reservation_id r[1]=username r[2]=student_user_id
        r[3]=student_grade r[4]=full_name r[5]=grade_level
        r[6]=strand r[7]=status r[8]=created_at
        r[9]=reserved_by_role r[10]=parent_name r[11]=relationship
        #}
        {% set role = (r[9] if r|length > 9 else 'student') or 'student' %}
        {% set grade = (r[5] or r[3] or '') %}
        {% set status = (r[7] or '') %}
        {% set fullname = (r[4] or r[1] or '') %}
        <tr class="{{ 'parent-row' if role == 'parent' else 'student-row' }}" data-role="{{ role }}"
          data-status="{{ status|upper }}" data-grade="{{ grade }}" data-name="{{ fullname|lower }}">
          <td><strong>#{{ r[0] }}</strong></td>
          <td>
            <div><strong>{{ fullname or '-' }}</strong></div>
            <div class="student-sub">{{ r[1] or '' }}</div>
          </td>
          <td>{{ grade or '-' }}</td>
          <td>
            {% if role == 'parent' %}
            <div>{{ r[10] or '-' }}</div>
            <span class="badge-parent">üë®‚Äçüë©‚Äçüëß Parent</span>
            <div class="student-sub">
              {{ r[11] or 'Guardian' }} of {{ fullname or '-' }}
            </div>
            {% else %}
            üë®‚Äçüéì Student
            {% endif %}
          </td>
          <td>
            <span class="status-badge status-{{ status|lower }}">{{ status }}</span>
          </td>
          <td>{{ r[8].strftime('%Y-%m-%d %H:%M') if r[8] else '-' }}</td>
          <td>
            <a href="{{ url_for('cashier.cashier_reservation_view', reservation_id=r[0]) }}" class="action-link">View
              ‚Üí</a>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
    <div id="noFilterResults">
      üîç No reservations match the selected filters.
    </div>
  </div>

  {% else %}
  <div class="card">
    <div class="empty-state">
      <div class="empty-icon">üì≠</div>
      <h3>No Reservations Yet</h3>
      <p>There are no student or parent reservations at the moment.</p>
    </div>
  </div>
  {% endif %}

</div>
{% endblock %}

{% block scripts %}
<script>
  function applyFilters() {
    const fRole = (document.getElementById('fUserType')?.value || '').toLowerCase();
    const fStatus = (document.getElementById('fStatus')?.value || '').toUpperCase();
    const fGrade = (document.getElementById('fGrade')?.value || '').toLowerCase().trim();
    const fSearch = (document.getElementById('fSearch')?.value || '').toLowerCase().trim();

    const rows = document.querySelectorAll('#resBody tr');
    let visible = 0;

    rows.forEach(function (row) {
      const role = (row.dataset.role || '').toLowerCase();
      const status = (row.dataset.status || '').toUpperCase();
      const grade = (row.dataset.grade || '').toLowerCase().trim();
      const name = (row.dataset.name || '').toLowerCase();

      const okRole = !fRole || role === fRole;
      const okStatus = !fStatus || status === fStatus;
      const okGrade = !fGrade || grade === fGrade;
      const okSearch = !fSearch || name.includes(fSearch);

      if (okRole && okStatus && okGrade && okSearch) {
        row.classList.remove('hidden');
        visible++;
      } else {
        row.classList.add('hidden');
      }
    });

    const noRes = document.getElementById('noFilterResults');
    if (noRes) noRes.style.display = visible === 0 ? 'block' : 'none';
  }
</script>
{% endblock %}