{% extends "base.html" %}

{% block title %}Book Release{% endblock %}

{% block styles %}
<style>
  * {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
  }

  body {
    background: #f5f7fa;
    color: #333;
  }

  .container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 20px;
  }

  header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 18px;
    padding-bottom: 18px;
    border-bottom: 2px solid #ddd;
    gap: 12px;
  }

  .header-left {
    display: flex;
    flex-direction: column;
    gap: 4px;
  }

  h1 {
    font-size: 28px;
    color: #222;
  }

  .header-subtitle {
    font-size: 13px;
    color: #999;
  }

  .header-actions {
    display: flex;
    gap: 10px;
    align-items: center;
    flex-wrap: wrap;
  }

  .btn {
    padding: 10px 16px;
    border: 1px solid #ddd;
    border-radius: 8px;
    background: #f8f8f8;
    color: #222;
    cursor: pointer;
    text-decoration: none;
    display: inline-block;
    font-size: 14px;
    font-weight: 500;
    transition: background 0.2s;
    white-space: nowrap;
  }

  .btn:hover {
    background: #efefef;
  }

  .btn-primary {
    background: #28a745;
    color: #fff;
    border-color: #28a745;
    padding: 12px 24px;
    font-size: 15px;
  }

  .btn-primary:hover {
    background: #218838;
  }

  .btn-info {
    background: #007bff;
    color: #fff;
    border-color: #007bff;
  }

  .btn-info:hover {
    background: #0056b3;
  }

  .card {
    background: #fff;
    border-radius: 12px;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
    padding: 26px;
    margin-bottom: 20px;
  }

  .form-section {
    margin-bottom: 28px;
  }

  .form-section h3 {
    font-size: 16px;
    font-weight: 600;
    color: #222;
    margin-bottom: 16px;
    padding-bottom: 10px;
    border-bottom: 2px solid #eee;
  }

  .form-row {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 18px;
    margin-bottom: 16px;
  }

  .form-group {
    display: flex;
    flex-direction: column;
  }

  label {
    font-weight: 600;
    color: #555;
    font-size: 14px;
    margin-bottom: 8px;
  }

  input,
  select {
    padding: 12px 14px;
    border: 1px solid #ddd;
    border-radius: 8px;
    font-size: 14px;
    transition: border-color 0.2s, box-shadow 0.2s;
    font-family: inherit;
  }

  input:focus,
  select:focus {
    outline: none;
    border-color: #28a745;
    box-shadow: 0 0 0 3px rgba(40, 167, 69, 0.1);
  }

  .help-text {
    font-size: 12px;
    color: #999;
    margin-top: 4px;
  }

  .form-actions {
    display: flex;
    gap: 12px;
    margin-top: 22px;
    padding-top: 16px;
    border-top: 1px solid #eee;
  }

  .form-actions .btn-primary {
    flex: 1;
  }

  table {
    width: 100%;
    border-collapse: collapse;
    font-size: 13px;
  }

  thead {
    background: #f8f9fa;
    border-bottom: 2px solid #ddd;
  }

  th {
    padding: 12px 8px;
    text-align: left;
    font-weight: 600;
    color: #555;
    font-size: 12px;
    text-transform: uppercase;
    letter-spacing: 0.02em;
  }

  td {
    padding: 12px 8px;
    border-bottom: 1px solid #eee;
    vertical-align: middle;
  }

  tbody tr {
    transition: background 0.2s;
  }

  tbody tr:hover {
    background: #f9f9f9;
  }

  .book-title {
    font-weight: 600;
    color: #222;
  }

  .book-info {
    font-size: 12px;
    color: #999;
  }

  .price {
    color: #28a745;
    font-weight: 600;
  }

  .muted {
    color: #999;
    font-size: 13px;
    text-align: center;
    padding: 32px 16px;
  }

  .message {
    padding: 14px 18px;
    border-radius: 8px;
    margin-bottom: 18px;
    font-weight: 500;
  }

  .message-success {
    background: #d1e7dd;
    color: #0f5132;
    border: 1px solid #badbcc;
  }

  .message-error {
    background: #f8d7da;
    color: #842029;
    border: 1px solid #f5c2c7;
  }

  .loading-overlay {
    position: fixed;
    inset: 0;
    background: rgba(255, 255, 255, 0.8);
    display: none;
    justify-content: center;
    align-items: center;
    z-index: 9999;
  }

  .loading-overlay.active {
    display: flex;
  }

  .spinner {
    border: 4px solid #f3f3f3;
    border-top: 4px solid #28a745;
    border-radius: 50%;
    width: 40px;
    height: 40px;
    animation: spin 1s linear infinite;
  }

  @keyframes spin {
    0% {
      transform: rotate(0deg)
    }

    100% {
      transform: rotate(360deg)
    }
  }

  /* Recent releases modal/panel */
  .modal-backdrop {
    position: fixed;
    inset: 0;
    background: rgba(0, 0, 0, 0.35);
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 9998;
    padding: 18px;
  }

  .modal-backdrop.active {
    display: flex;
  }

  .modal {
    width: min(1100px, 100%);
    background: #fff;
    border-radius: 14px;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.18);
    overflow: hidden;
  }

  .modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 16px 18px;
    border-bottom: 1px solid #eee;
    background: #fafafa;
    gap: 12px;
  }

  .modal-title {
    font-size: 16px;
    font-weight: 700;
    color: #222;
  }

  .modal-body {
    padding: 16px 18px;
  }

  .modal-actions {
    display: flex;
    gap: 10px;
    align-items: center;
    flex-wrap: wrap;
  }

  .close-x {
    border: 1px solid #ddd;
    background: #fff;
    border-radius: 10px;
    padding: 8px 10px;
    cursor: pointer;
  }

  .close-x:hover {
    background: #f2f2f2;
  }

  .filter-row {
    display: flex;
    gap: 12px;
    align-items: end;
    flex-wrap: wrap;
    margin-bottom: 12px;
  }

  .filter-row .form-group {
    min-width: 240px;
  }

  .tiny {
    font-size: 12px;
    color: #888;
  }
</style>
{% endblock %}

{% block content %}
<div class="loading-overlay" id="loadingOverlay">
  <div class="spinner"></div>
</div>

<div class="container">
  <header>
    <div class="header-left">
      <h1>üßæ Book Release</h1>
      <div class="header-subtitle">Release books to a student (by Enrollment ID or Student Name)</div>
    </div>

    <div class="header-actions">
      <button type="button" class="btn btn-info" id="openRecentBtn">üìã Recent Releases</button>
      <a href="{{ url_for('librarian.dashboard') }}" class="btn">‚¨Ö Back</a>
    </div>
  </header>

  {% if message %}
  <div class="message message-success">‚úÖ {{ message }}</div>
  {% endif %}
  {% if error %}
  <div class="message message-error">‚ùå {{ error }}</div>
  {% endif %}

  <!-- Recent Releases Modal -->
  <div class="modal-backdrop" id="recentModal">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="recentTitle">
      <div class="modal-header">
        <div>
          <div class="modal-title" id="recentTitle">üìã Recent Releases</div>
          <div class="tiny">Filter by student grade (requires <code>student_grade</code> on each release row).</div>
        </div>
        <div class="modal-actions">
          <button type="button" class="close-x" id="closeRecentBtn">‚úñ Close</button>
        </div>
      </div>

      <div class="modal-body">
        <div class="filter-row">
          <div class="form-group">
            <label for="recentGradeFilter">üéì Filter Student Grade</label>
            <select id="recentGradeFilter">
              <option value="">All Grades</option>
              {% for g in grades %}
              <option value="{{ g }}">{{ g }}</option>
              {% endfor %}
            </select>
            <div class="help-text">Shows only releases for the selected student grade</div>
          </div>

          <div class="form-group" style="min-width: 320px;">
            <label for="recentSearch">üîé Search</label>
            <input id="recentSearch" type="text" placeholder="Search student / enrollment / book...">
            <div class="help-text">Quick search in recent releases list</div>
          </div>
        </div>

        {% if releases and releases|length > 0 %}
        <table>
          <thead>
            <tr>
              <th>Date</th>
              <th>Enrollment ID</th>
              <th>Student Name</th>
              <th>Student Grade</th>
              <th>Book Details</th>
              <th>Qty</th>
            </tr>
          </thead>
          <tbody id="recentReleasesBody">
            {% for r in releases %}
            <tr data-student-grade="{{ r.student_grade|default('') }}"
              data-search="{{ (r.enrollment_id ~ ' ' ~ r.student_name ~ ' ' ~ r.book_display)|lower }}">
              <td>{{ r.created_at }}</td>
              <td><strong>{{ r.enrollment_id }}</strong></td>
              <td>{{ r.student_name }}</td>
              <td><strong>{{ r.student_grade|default('‚Äî') }}</strong></td>
              <td>{{ r.book_display }}</td>
              <td><strong>{{ r.qty }}</strong></td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
        {% else %}
        <div class="muted">üì≠ No releases recorded yet.</div>
        {% endif %}
      </div>
    </div>
  </div>

  <!-- Release Form -->
  <div class="card">
    <div class="form-section">
      <h3>üìö Release Books</h3>

      <form method="post" id="releaseForm">
        <div class="form-row">
          <div class="form-group">
            <label for="enrollment_id">üÜî Enrollment ID (Recommended)</label>
            <input type="text" id="enrollment_id" name="enrollment_id" placeholder="e.g., 123" value="">
            <div class="help-text">Enter student enrollment ID</div>
          </div>

          <div class="form-group">
            <label for="student_name">üë§ Student Name (Optional)</label>
            <input type="text" id="student_name" name="student_name" placeholder="Student full name" value="">
            <div class="help-text">Or search by student name</div>
          </div>

          <div class="form-group">
            <label for="qty">üì¶ Quantity</label>
            <input type="number" id="qty" name="qty" value="1" min="1" required>
            <div class="help-text">Number of books to release</div>
          </div>
        </div>

        <!-- BOOK FILTER BY GRADE -->
        <div class="form-row">
          <div class="form-group">
            <label for="bookGradeFilter">üéì Filter Book Grade</label>
            <select id="bookGradeFilter">
              <option value="">All Grades</option>
              {% for g in grades %}
              <option value="{{ g }}">{{ g }}</option>
              {% endfor %}
            </select>
            <div class="help-text">Auto filter the book list by grade (Nursery ‚Üí Kinder ‚Üí Grade 1-10)</div>
          </div>

          <div class="form-group">
            <label for="bookSearch">üîé Search Book</label>
            <input id="bookSearch" type="text" placeholder="Search title / publisher...">
            <div class="help-text">Quick search in book list</div>
          </div>
        </div>

        <!-- Books Table Selection -->
        <div class="form-section">
          <h3>üìñ Select Book</h3>

          <div class="books-table-container">
            {% if books and books|length > 0 %}
            <table>
              <thead>
                <tr>
                  <th style="width: 40px;"></th>
                  <th>Grade Level</th>
                  <th>Publisher</th>
                  <th>Title</th>
                  <th>Price</th>
                </tr>
              </thead>

              <tbody id="booksTbody">
                {% for b in books %}
                <tr data-grade="{{ b.grade_level }}"
                  data-search="{{ (b.publisher ~ ' ' ~ b.title ~ ' ' ~ b.grade_level)|lower }}">
                  <td>
                    <input type="radio" id="book_{{ b.item_id }}" name="item_id" value="{{ b.item_id }}" required>
                  </td>
                  <td>{{ b.grade_level }}</td>
                  <td><strong>{{ b.publisher }}</strong></td>
                  <td class="book-title">{{ b.title }}</td>
                  <td class="price">‚Ç±{{ "%.2f"|format(b.price or 0) }}</td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
            {% else %}
            <div class="muted">üì≠ No books available.</div>
            {% endif %}
          </div>
        </div>

        <div class="form-actions">
          <button type="submit" class="btn btn-primary">‚úÖ Record Release</button>
        </div>
      </form>
    </div>
  </div>
</div>

<script>
  // Grade order for proper sorting (Nursery ‚Üí Kinder ‚Üí Grade 1-10)
  const gradeOrder = {
    'Nursery': 0,
    'Kinder': 1,
    'Grade 1': 2,
    'Grade 2': 3,
    'Grade 3': 4,
    'Grade 4': 5,
    'Grade 5': 6,
    'Grade 6': 7,
    'Grade 7': 8,
    'Grade 8': 9,
    'Grade 9': 10,
    'Grade 10': 11
  };

  // Loading overlay on submit
  const form = document.getElementById('releaseForm');
  const loadingOverlay = document.getElementById('loadingOverlay');
  form.addEventListener('submit', function () {
    loadingOverlay.classList.add('active');
  });

  // Recent Releases modal open/close
  const recentModal = document.getElementById('recentModal');
  const openRecentBtn = document.getElementById('openRecentBtn');
  const closeRecentBtn = document.getElementById('closeRecentBtn');

  openRecentBtn.addEventListener('click', () => recentModal.classList.add('active'));
  closeRecentBtn.addEventListener('click', () => recentModal.classList.remove('active'));
  recentModal.addEventListener('click', (e) => {
    if (e.target === recentModal) recentModal.classList.remove('active');
  });

  // Book filtering (grade + search)
  const bookGradeFilter = document.getElementById('bookGradeFilter');
  const bookSearch = document.getElementById('bookSearch');
  const booksTbody = document.getElementById('booksTbody');

  function applyBookFilters() {
    if (!booksTbody) return;

    const selectedGrade = (bookGradeFilter.value || '').trim();
    const q = (bookSearch.value || '').trim().toLowerCase();

    // Get all rows and sort them by grade order
    const rows = [...booksTbody.querySelectorAll('tr')];

    rows.forEach(tr => {
      const trGrade = (tr.dataset.grade || '').trim();
      const trSearch = (tr.dataset.search || '').trim();

      // Check grade filter
      const gradeOk = !selectedGrade || trGrade === selectedGrade;
      // Check search filter
      const searchOk = !q || trSearch.includes(q);

      tr.style.display = (gradeOk && searchOk) ? '' : 'none';
    });

    // Sort visible rows by grade order
    if (!selectedGrade) {
      rows.sort((a, b) => {
        const gradeA = a.dataset.grade || '';
        const gradeB = b.dataset.grade || '';
        const orderA = gradeOrder[gradeA] ?? 999;
        const orderB = gradeOrder[gradeB] ?? 999;
        return orderA - orderB;
      });

      // Re-append in sorted order
      rows.forEach(row => {
        if (row.style.display !== 'none') {
          booksTbody.appendChild(row);
        }
      });
    }
  }

  bookGradeFilter.addEventListener('change', applyBookFilters);
  bookSearch.addEventListener('input', applyBookFilters);

  // Recent releases filtering (student grade + search)
  const recentGradeFilter = document.getElementById('recentGradeFilter');
  const recentSearch = document.getElementById('recentSearch');
  const recentReleasesBody = document.getElementById('recentReleasesBody');

  function applyRecentFilters() {
    if (!recentReleasesBody) return;

    const selectedGrade = (recentGradeFilter.value || '').trim();
    const q = (recentSearch.value || '').trim().toLowerCase();

    [...recentReleasesBody.querySelectorAll('tr')].forEach(tr => {
      const trGrade = (tr.dataset.studentGrade || '').trim();
      const trSearch = (tr.dataset.search || '').trim();
      const gradeOk = !selectedGrade || trGrade === selectedGrade;
      const searchOk = !q || trSearch.includes(q);
      tr.style.display = (gradeOk && searchOk) ? '' : 'none';
    });
  }

  if (recentGradeFilter) recentGradeFilter.addEventListener('change', applyRecentFilters);
  if (recentSearch) recentSearch.addEventListener('input', applyRecentFilters);

  // Auto filter by student grade when Enrollment ID is entered
  const enrollmentInput = document.getElementById('enrollment_id');

  let gradeFetchTimer = null;
  async function fetchStudentGrade(enrollmentId) {
    const url = `/librarian/api/student-grade?enrollment_id=${encodeURIComponent(enrollmentId)}`;
    const res = await fetch(url);
    if (!res.ok) return null;
    return await res.json();
  }

  if (enrollmentInput) {
    enrollmentInput.addEventListener('input', () => {
      clearTimeout(gradeFetchTimer);
      const val = (enrollmentInput.value || '').trim();

      if (!val) return;

      gradeFetchTimer = setTimeout(async () => {
        try {
          const data = await fetchStudentGrade(val);
          if (data && data.grade_level) {
            bookGradeFilter.value = data.grade_level;
            if (recentGradeFilter) recentGradeFilter.value = data.grade_level;

            applyBookFilters();
            applyRecentFilters();
          }
        } catch (err) {
          // silent fail
        }
      }, 450);
    });
  }

  // Initial apply
  applyBookFilters();
  applyRecentFilters();
</script>
{% endblock %}