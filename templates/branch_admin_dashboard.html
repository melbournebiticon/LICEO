{% extends "base.html" %}

{% block title %}Branch Admin{% endblock %}

{% block content %}
<style>
  .container {
    max-width: 1100px;
    margin: 0 auto;
    padding: 20px;
  }

  .header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 16px;
  }

  .card {
    background: #fff;
    border: 1px solid #eee;
    border-radius: 12px;
    padding: 16px;
    box-shadow: 0 2px 8px rgba(0, 0, 0, .06);
    margin-bottom: 14px;
  }

  .grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
    gap: 12px;
  }

  .btn {
    display: inline-block;
    padding: 10px 14px;
    border-radius: 10px;
    border: 1px solid #ddd;
    background: #f8f8f8;
    text-decoration: none;
    color: #222;
    font-weight: 600;
  }

  .btn:hover {
    background: #efefef;
  }

  .btn-primary {
    background: #007bff;
    color: #fff;
    border-color: #007bff;
  }

  .btn-primary:hover {
    background: #0056b3;
  }

  .btn-danger {
    background: #dc3545;
    color: #fff;
    border-color: #dc3545;
  }

  .btn-danger:hover {
    background: #c82333;
  }

  .muted {
    color: #666;
    font-size: 13px;
  }

  .row {
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
    align-items: center;
  }

  .field {
    width: 100%;
    padding: 10px;
    border: 1px solid #ddd;
    border-radius: 10px;
  }

  .actions {
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
  }

  .badge {
    display: inline-block;
    padding: 4px 10px;
    border-radius: 999px;
    background: #eef6ff;
    color: #0b5ed7;
    font-size: 12px;
    font-weight: 700;
  }

  .success {
    background: #d1e7dd;
    color: #0f5132;
    border: 1px solid #badbcc;
    padding: 12px;
    border-radius: 10px;
  }
</style>

<div class="container">
  <div class="header">
    <div>
      <h1 style="margin:0;">Branch Admin</h1>
      <div class="muted">Manage branch users, FAQs, and inventory.</div>
    </div>
    <div class="actions">
      <a class="btn" href="{{ url_for('auth.change_password') }}">Change Password</a>
      <a class="btn btn-danger" href="{{ url_for('auth.logout') }}">Logout</a>
    </div>
  </div>

  <!-- HOMEPAGE ANNOUNCEMENTS (visible to all branches) -->
  <div class="card">
    <h2 style="margin:0 0 6px 0;">üì¢ Homepage Announcements</h2>
    <div class="muted" style="margin-bottom:12px;">
      These show on the main homepage. Everyone (all branches) can see them.
    </div>

    <form method="post" action="{{ url_for('branch_admin.dashboard') }}" enctype="multipart/form-data">
      <input type="hidden" name="add_announcement" value="1">
      <div class="row" style="flex-wrap:wrap; gap:10px;">
        <div style="flex:1; min-width:200px;">
          <label style="font-weight:700; font-size:13px;">Title *</label>
          <input class="field" name="announcement_title" placeholder="e.g. Enrollment is open" required
            style="margin-top:4px;">
        </div>
        <div style="flex:2; min-width:260px;">
          <label style="font-weight:700; font-size:13px;">Message</label>
          <input class="field" name="announcement_message" placeholder="Short message for the homepage"
            style="margin-top:4px;">
        </div>
      </div>
      <div style="margin-top:10px; display:flex; align-items:flex-end; gap:14px; flex-wrap:wrap;">
        <div style="flex:1; min-width:220px;">
          <label style="font-weight:700; font-size:13px;">üì∑ Photo (optional)</label>
          <div style="margin-top:4px; display:flex; align-items:center; gap:8px;">
            <input type="file" name="announcement_photo" id="announcementPhoto"
              accept="image/png,image/jpeg,image/gif,image/webp" class="field" style="padding:6px; cursor:pointer;"
              onchange="previewPhoto(this)">
            <span id="photoPreviewWrap" style="display:none;">
              <img id="photoPreview" src="" alt="preview" style="height:48px; width:72px; object-fit:cover;
                          border-radius:8px; border:1px solid #ddd;">
            </span>
          </div>
          <div class="muted" style="margin-top:3px; font-size:11px;">
            PNG / JPG / GIF / WEBP ‚Äî will appear as a slide on the homepage
          </div>
        </div>
        <div>
          <button class="btn btn-primary" type="submit">üìå Add to Homepage</button>
        </div>
      </div>
    </form>

    {% if announcements_list %}
    <div style="margin-top:16px;">
      <div style="font-weight:700; font-size:13px; margin-bottom:8px;">
        Current announcements
      </div>
      <ul style="margin:0; padding:0; list-style:none; display:flex; flex-direction:column; gap:8px;">
        {% for a in announcements_list %}
        <li style="display:flex; align-items:center; gap:12px;
                   background:#f8f9fa; border-radius:10px; padding:10px 12px;">
          {% if a.image_url %}
          <img src="{{ a.image_url }}" alt="photo" style="width:64px; height:44px; object-fit:cover; border-radius:8px;
                      border:1px solid #ddd; flex-shrink:0;">
          {% else %}
          <div style="width:64px; height:44px; border-radius:8px; background:#eee;
                      display:flex; align-items:center; justify-content:center;
                      font-size:20px; flex-shrink:0;">üì¢</div>
          {% endif %}
          <div style="flex:1; min-width:0;">
            <strong>{{ a.title }}</strong>
            {% if a.message %}
            <span style="color:#666;"> ‚Äì {{ a.message[:70] }}{% if a.message|length > 70 %}...{% endif %}</span>
            {% endif %}
            <div class="muted" style="font-size:11px; margin-top:2px;">
              {{ a.created_at.strftime('%Y-%m-%d %H:%M') if a.created_at else '' }}
              {% if not a.is_active %}<span style="color:#dc3545;"> ¬∑ hidden</span>{% endif %}
            </div>
          </div>
          {% if a.is_active %}
          <form method="post" action="{{ url_for('branch_admin.announcement_hide', announcement_id=a.id) }}"
            style="flex-shrink:0;">
            <button type="submit" class="btn" style="padding:5px 10px; font-size:12px;">Hide</button>
          </form>
          {% endif %}
        </li>
        {% endfor %}
      </ul>
    </div>
    {% endif %}
  </div>

  <script>
    function previewPhoto(input) {
      const wrap = document.getElementById('photoPreviewWrap');
      const img = document.getElementById('photoPreview');
      if (input.files && input.files[0]) {
        img.src = URL.createObjectURL(input.files[0]);
        wrap.style.display = 'inline';
      } else {
        wrap.style.display = 'none';
      }
    }
  </script>

  <!-- QUICK LINKS -->
  <div class="card">
    <h2 style="margin:0 0 10px 0;">Quick Actions</h2>
    <div class="grid">
      <a class="btn btn-primary" href="{{ url_for('branch_admin.branch_admin_faqs') }}">ü§ñ Manage Branch FAQs</a>
      <a class="btn btn-primary" href="{{ url_for('branch_admin.branch_admin_inventory') }}">üì¶ Inventory List</a>
      <a class="btn" href="{{ url_for('branch_admin.branch_admin_inventory_add') }}">‚ûï Add Inventory Item</a>

      <div class="card" style="margin:0; padding:12px; border-style:dashed;">
        <div style="font-weight:700;">üí° Restock / Update Price</div>
        <div class="muted" style="margin-top:6px;">
          Open Inventory List, then click <b>Restock</b> or <b>Update Price</b> on an item.
        </div>
        <a class="btn" style="margin-top:10px;" href="{{ url_for('branch_admin.branch_admin_inventory') }}">Go to
          Inventory</a>
      </div>
    </div>
  </div>

  <!-- CREATE USERS -->
  <div class="card">
    <h2 style="margin:0 0 6px 0;">Create Registrar / Cashier / Teacher</h2>
    <div class="muted" style="margin-bottom:12px;">
      Creates a user under your branch.
    </div>

    <form method="post" action="{{ url_for('branch_admin.dashboard') }}">
      <div class="row">
        <div style="flex:1; min-width:260px;">
          <label style="font-weight:700; font-size:13px;">Base Username</label>
          <input class="field" name="username" placeholder="e.g., juan" required>
          <div class="muted" style="margin-top:6px;">Tip: use a short base username.</div>
        </div>

        <div style="flex:1; min-width:220px;">
          <label style="font-weight:700; font-size:13px;">Role</label>
          <select class="field" name="role" required id="roleSelect" onchange="toggleTeacherFields(this.value)">
            <option value="registrar">Registrar</option>
            <option value="cashier">Cashier</option>
            <option value="librarian">Librarian</option>
            <option value="teacher">Teacher</option>
          </select>
        </div>

        <div style="display:flex; align-items:flex-end;">
          <button class="btn btn-primary" type="submit">Create User</button>
        </div>
      </div>

      <!-- Teacher-only fields -->
      <div id="teacherFields" style="display:none; margin-top:14px;
           background:#f0f9ff; border:1px solid #bae6fd; border-radius:12px; padding:14px;">
        <div style="font-weight:700; font-size:13px; margin-bottom:10px; color:#0369a1;">
          üë©‚Äçüè´ Teacher Details
        </div>
        <div class="row" style="gap:12px; flex-wrap:wrap;">

          <!-- Full Name -->
          <div style="flex:2; min-width:220px;">
            <label style="font-weight:700; font-size:13px;">Full Name *</label>
            <input class="field" name="full_name" id="fullNameInput" placeholder="e.g., Joy Cruz"
              style="margin-top:4px;">
            <div class="muted" style="font-size:12px; margin-top:3px;">
              This will show on class announcements (e.g., Ms. Joy Cruz).
            </div>
          </div>

          <!-- Gender -->
          <div style="flex:1; min-width:160px;">
            <label style="font-weight:700; font-size:13px;">Gender *</label>
            <select class="field" name="gender" id="genderSelect" style="margin-top:4px;">
              <option value="">‚Äî Select ‚Äî</option>
              <option value="female">Female (Ms.)</option>
              <option value="male">Male (Mr.)</option>
            </select>
          </div>

          <!-- Grade Level -->
          <div style="flex:1; min-width:180px;">
            <label style="font-weight:700; font-size:13px;">Assigned Grade Level</label>
            <select class="field" name="grade_level" style="margin-top:4px;">
              <option value="">‚Äî Select Grade ‚Äî</option>
              <option>Kinder</option>
              <option>Grade 1</option>
              <option>Grade 2</option>
              <option>Grade 3</option>
              <option>Grade 4</option>
              <option>Grade 5</option>
              <option>Grade 6</option>
              <option>Grade 7</option>
              <option>Grade 8</option>
              <option>Grade 9</option>
              <option>Grade 10</option>
              <option>Grade 11</option>
              <option>Grade 12</option>
            </select>
            <div class="muted" style="font-size:12px; margin-top:3px;">
              Teacher will auto-load this grade on their dashboard.
            </div>
          </div>

        </div>
      </div>
    </form>

    {% if created_user %}
    <div style="margin-top:14px;" class="success">
      <div style="font-weight:800; margin-bottom:6px;">User Created Successfully ‚úÖ</div>
      <div><span class="badge">{{ created_user.role }}</span></div>
      <div style="margin-top:8px;"><b>Username:</b> {{ created_user.username }}</div>
      <div><b>Temporary Password:</b> {{ created_user.password }}</div>
    </div>
    {% endif %}
  </div>
</div>

<script>
  function toggleTeacherFields(role) {
    const show = role === 'teacher';
    document.getElementById('teacherFields').style.display = show ? 'block' : 'none';
    document.getElementById('fullNameInput').required = show;
    document.getElementById('genderSelect').required = show;
  }

  function previewPhoto(input) {
    const wrap = document.getElementById('photoPreviewWrap');
    const img = document.getElementById('photoPreview');
    if (input.files && input.files[0]) {
      img.src = URL.createObjectURL(input.files[0]);
      wrap.style.display = 'inline';
    } else {
      wrap.style.display = 'none';
    }
  }
</script>
{% endblock %}