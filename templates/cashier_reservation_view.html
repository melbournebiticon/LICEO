{% extends "base.html" %}

{% block title %}Reservation #{{ header[0] }}{% endblock %}

{% block styles %}
<style>
  * {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
  }

  body {
    background: #f5f7fa;
    color: #333;
  }

  .container {
    max-width: 960px;
    margin: 0 auto;
    padding: 20px;
  }

  header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 24px;
    padding-bottom: 18px;
    border-bottom: 2px solid #ddd;
    flex-wrap: wrap;
    gap: 12px;
  }

  h1 {
    font-size: 26px;
    color: #222;
  }

  .header-actions {
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
  }

  .card {
    background: white;
    border-radius: 12px;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
    padding: 22px;
    margin-bottom: 18px;
  }

  .card h2 {
    font-size: 17px;
    font-weight: 700;
    margin-bottom: 14px;
    color: #222;
  }

  .card h3 {
    font-size: 15px;
    font-weight: 700;
    margin-bottom: 12px;
    color: #444;
  }

  .info-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
    gap: 16px;
    margin-bottom: 14px;
  }

  .info-item {
    display: flex;
    flex-direction: column;
  }

  .info-label {
    font-size: 11px;
    color: #999;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    margin-bottom: 3px;
  }

  .info-value {
    font-size: 15px;
    color: #222;
    font-weight: 500;
  }

  .status-badge {
    display: inline-block;
    padding: 5px 14px;
    border-radius: 20px;
    font-size: 13px;
    font-weight: 700;
  }

  .status-reserved {
    background: #fff3cd;
    color: #856404;
    border: 1px solid #ffeaa7;
  }

  .status-paid {
    background: #cfe2ff;
    color: #084298;
    border: 1px solid #b6d4fe;
  }

  .status-claimed {
    background: #d1e7dd;
    color: #0f5132;
    border: 1px solid #badbcc;
  }

  .status-cancelled {
    background: #f8d7da;
    color: #842029;
    border: 1px solid #f5c2c7;
  }

  .user-type-badge {
    display: inline-block;
    padding: 4px 10px;
    border-radius: 12px;
    font-size: 11px;
    font-weight: 700;
    margin-left: 6px;
    vertical-align: middle;
  }

  .user-type-student {
    background: #e3f2fd;
    color: #1565c0;
    border: 1px solid #90caf9;
  }

  .user-type-parent {
    background: #f3e5f5;
    color: #7b1fa2;
    border: 1px solid #ce93d8;
  }

  .parent-info-box {
    background: #f3e5f5;
    border-left: 4px solid #7b1fa2;
    padding: 12px 16px;
    border-radius: 8px;
    margin-top: 14px;
    font-size: 13px;
  }

  .parent-info-box strong {
    color: #7b1fa2;
  }

  /* Category tabs */
  .category-tabs {
    display: flex;
    gap: 8px;
    margin-bottom: 14px;
    flex-wrap: wrap;
  }

  .tab-btn {
    padding: 7px 16px;
    border-radius: 8px;
    border: 1px solid #ddd;
    background: #f8f8f8;
    color: #555;
    font-size: 13px;
    font-weight: 600;
    text-decoration: none;
    transition: all 0.15s;
    cursor: pointer;
  }

  .tab-btn:hover {
    background: #efefef;
  }

  .tab-btn.active {
    background: #1a2e5a;
    color: #fff;
    border-color: #1a2e5a;
  }

  table {
    border-collapse: collapse;
    width: 100%;
    font-size: 14px;
  }

  thead {
    background: #f8f9fa;
    border-bottom: 2px solid #ddd;
  }

  th {
    padding: 11px 14px;
    text-align: left;
    font-weight: 600;
    color: #555;
    font-size: 12px;
    text-transform: uppercase;
    letter-spacing: 0.04em;
  }

  td {
    padding: 11px 14px;
    border-bottom: 1px solid #eee;
    vertical-align: middle;
  }

  tbody tr:hover {
    background: #f9f9f9;
  }

  .total-row {
    background: #f8f9fa;
    font-weight: 700;
    border-top: 2px solid #ddd;
  }

  .total-row td {
    padding: 13px 14px;
  }

  .grand-total-row {
    background: #1a2e5a;
    color: #fff;
    font-weight: 700;
  }

  .grand-total-row td {
    padding: 13px 14px;
    color: #fff;
  }

  .btn {
    padding: 9px 16px;
    border: 1px solid #ddd;
    border-radius: 8px;
    background: #f8f8f8;
    color: #222;
    cursor: pointer;
    font-size: 13.5px;
    font-weight: 600;
    transition: all 0.15s;
    text-decoration: none;
    display: inline-flex;
    align-items: center;
    gap: 6px;
  }

  .btn:hover {
    background: #efefef;
    transform: translateY(-1px);
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
  }

  .btn-primary {
    background: #2563eb;
    color: #fff;
    border-color: #2563eb;
  }

  .btn-primary:hover {
    background: #1d4ed8;
  }

  .btn-success {
    background: #16a34a;
    color: #fff;
    border-color: #16a34a;
  }

  .btn-success:hover {
    background: #15803d;
  }

  .btn-danger {
    background: #dc2626;
    color: #fff;
    border-color: #dc2626;
  }

  .btn-danger:hover {
    background: #b91c1c;
  }

  .btn-info {
    background: #0891b2;
    color: #fff;
    border-color: #0891b2;
  }

  .btn-info:hover {
    background: #0e7490;
  }

  .actions {
    display: flex;
    gap: 10px;
    margin-top: 16px;
    flex-wrap: wrap;
  }

  form {
    display: inline;
  }

  .alert {
    padding: 12px 16px;
    border-radius: 8px;
    margin-bottom: 14px;
    font-size: 13px;
    border-left: 4px solid;
  }

  .alert-info {
    background: #eff6ff;
    color: #1e40af;
    border-color: #3b82f6;
  }

  .alert-success {
    background: #f0fdf4;
    color: #166534;
    border-color: #16a34a;
  }

  .alert-warning {
    background: #fffbeb;
    color: #92400e;
    border-color: #d97706;
  }

  @media (max-width: 600px) {
    .info-grid {
      grid-template-columns: 1fr 1fr;
    }

    .actions {
      flex-direction: column;
    }

    .actions button,
    .actions a,
    .actions form {
      width: 100%;
    }
  }
</style>
{% endblock %}

{% block content %}
<div class="container">
  <header>
    <h1>üìã Reservation #{{ header[0] }}</h1>
    <div class="header-actions">
      <a href="{{ url_for('cashier.cashier_reservations') }}" class="btn">‚¨Ö Back to List</a>
    </div>
  </header>

  {#
  header indexes:
  [0] reservation_id [1] username [2] student_user_id
  [3] grade_level [4] full_name [5] grade_level(fallback)
  [6] strand [7] status [8] created_at
  [9] reserved_by_role [10] parent_name [11] relationship
  #}

  <!-- ‚îÄ‚îÄ Reservation Info ‚îÄ‚îÄ -->
  <div class="card">
    <h2>Student Information</h2>

    <div class="info-grid">
      <div class="info-item">
        <span class="info-label">Student ID</span>
        <span class="info-value">{{ header[1] or '-' }}</span>
      </div>
      <div class="info-item">
        <span class="info-label">Full Name</span>
        <span class="info-value">{{ header[4] or '-' }}</span>
      </div>
      <div class="info-item">
        <span class="info-label">Grade Level</span>
        <span class="info-value">{{ header[5] or header[3] or '-' }}</span>
      </div>
      <div class="info-item">
        <span class="info-label">Reserved By</span>
        <span class="info-value">
          {% if header|length > 9 and header[9] == 'parent' %}
          <span class="user-type-badge user-type-parent">üë®‚Äçüë©‚Äçüëß Parent</span>
          {% else %}
          <span class="user-type-badge user-type-student">üë®‚Äçüéì Student</span>
          {% endif %}
        </span>
      </div>
      <div class="info-item">
        <span class="info-label">Status</span>
        <span class="status-badge status-{{ header[7]|lower }}">{{ header[7] }}</span>
      </div>
      <div class="info-item">
        <span class="info-label">Date Created</span>
        <span class="info-value">{{ header[8].strftime('%Y-%m-%d %H:%M') if header[8] else '-' }}</span>
      </div>
    </div>

    {% if header|length > 9 and header[9] == 'parent' %}
    <div class="parent-info-box">
      <strong>üë®‚Äçüë©‚Äçüëß Reserved by Parent</strong>
      <div style="margin-top: 10px; display: flex; flex-direction: column; gap: 6px;">
        {% if header|length > 10 and header[10] %}
        <div>
          <span
            style="font-size:11px; color:#9c4dc4; font-weight:700; text-transform:uppercase; letter-spacing:0.05em;">Parent
            Name</span><br>
          <strong>{{ header[10] }}</strong>
        </div>
        {% endif %}
        {% if header|length > 11 and header[11] %}
        <div>
          <span
            style="font-size:11px; color:#9c4dc4; font-weight:700; text-transform:uppercase; letter-spacing:0.05em;">Relationship</span><br>
          {{ header[11] }}
        </div>
        {% endif %}
        <div style="margin-top:4px; padding-top:10px; border-top: 1px solid #ddb3ec;">
          <span
            style="font-size:11px; color:#9c4dc4; font-weight:700; text-transform:uppercase; letter-spacing:0.05em;">For
            Student</span><br>
          <strong style="font-size:15px; color:#3b0764;">
            {{ header[4] or header[1] or '-' }}
          </strong>
          {% if header[5] or header[3] %}
          <span style="margin-left:8px; background:#e9d5f9; color:#7b1fa2; padding:2px 8px;
                       border-radius:10px; font-size:12px; font-weight:600;">
            {{ header[5] or header[3] }}
          </span>
          {% endif %}
        </div>
      </div>
    </div>
    {% endif %}
  </div>

  <!-- ‚îÄ‚îÄ Items ‚îÄ‚îÄ -->
  <div class="card">
    <h2>üì¶ Reserved Items</h2>

    {% if categories and categories|length > 1 %}
    <div class="category-tabs">
      {% for cat in categories %}
      <a href="?category={{ cat }}" class="tab-btn {% if selected_category == cat %}active{% endif %}">
        {% if cat == 'UNIFORM' %}üëï{% elif cat == 'BOOK' %}üìö{% else %}üì¶{% endif %}
        {{ cat|title }}
      </a>
      {% endfor %}
    </div>
    {% endif %}

    {% if items %}
    <table>
      <thead>
        <tr>
          <th>Item Name</th>
          <th>Qty</th>
          {% if selected_category == 'BOOK' %}
          <th>üìö Publisher</th>
          {% elif selected_category == 'UNIFORM' %}
          <th>üìê Size</th>
          {% else %}
          <th>Size / Publisher</th>
          {% endif %}
          <th style="text-align:right;">Unit Price</th>
          <th style="text-align:right;">Total</th>
        </tr>
      </thead>
      <tbody>
        {% for it in items %}
        {# it: [0]=item_name [1]=qty [2]=size_label [3]=unit_price [4]=line_total [5]=category #}
        {% set item_cat = (it[5] or selected_category or '') | upper %}
        <tr>
          <td><strong>{{ it[0] }}</strong></td>
          <td style="text-align:center;">{{ it[1] }}</td>
          <td style="text-align:center;">
            {% if it[2] %}
            {% if item_cat == 'BOOK' %}
            {# Publisher ‚Äî blue pill #}
            <span style="background:#dbeafe; color:#1d4ed8; padding:3px 10px;
                             border-radius:12px; font-size:12px; font-weight:600;
                             border:1px solid #bfdbfe;">{{ it[2] }}</span>
            {% elif item_cat == 'UNIFORM' %}
            {# Size ‚Äî grey pill #}
            <span style="background:#f0f0f0; color:#444; padding:3px 10px;
                             border-radius:12px; font-size:12px; font-weight:700;
                             border:1px solid #ddd; letter-spacing:0.05em;">{{ it[2] }}</span>
            {% else %}
            <span style="background:#f0f0f0; padding:3px 8px; border-radius:4px;
                             font-size:12px;">{{ it[2] }}</span>
            {% endif %}
            {% else %}
            <span style="color:#bbb;">‚Äî</span>
            {% endif %}
          </td>
          <td style="text-align:right;">‚Ç±{{ '%.2f'|format(it[3] or 0) }}</td>
          <td style="text-align:right;"><strong>‚Ç±{{ '%.2f'|format(it[4] or 0) }}</strong></td>
        </tr>
        {% endfor %}
        <tr class="total-row">
          <td colspan="4" style="text-align:right;">
            {% if categories and categories|length > 1 %}
            {{ selected_category|title }} Subtotal:
            {% else %}
            TOTAL:
            {% endif %}
          </td>
          <td style="text-align:right;">‚Ç±{{ '%.2f'|format(total or 0) }}</td>
        </tr>
        {% if categories and categories|length > 1 %}
        <tr class="grand-total-row">
          <td colspan="4" style="text-align:right;">GRAND TOTAL (All Items):</td>
          <td style="text-align:right;">‚Ç±{{ '%.2f'|format(grand_total or 0) }}</td>
        </tr>
        {% endif %}
      </tbody>
    </table>
    {% else %}
    <div style="text-align:center; padding:30px; color:#999;">
      üì≠ No items found for this reservation.
    </div>
    {% endif %}
  </div>

  <!-- ‚îÄ‚îÄ Actions ‚îÄ‚îÄ -->
  <div class="card">
    <h3>‚ö° Actions</h3>

    {% if header[7] == 'RESERVED' %}
    <div class="alert alert-info">
      ‚ÑπÔ∏è Reservation is pending payment. Collect payment then mark as PAID.
    </div>
    <div class="actions">
      <form method="post" action="{{ url_for('cashier.cashier_mark_paid', reservation_id=header[0]) }}">
        <button class="btn btn-success" type="submit">‚úÖ Mark as PAID</button>
      </form>
      <form method="post" action="{{ url_for('cashier.cashier_cancel_reservation', reservation_id=header[0]) }}">
        <button class="btn btn-danger" type="submit" onclick="return confirm('Cancel this reservation?')">‚ùå Cancel
          Reservation</button>
      </form>
    </div>

    {% elif header[7] == 'PAID' %}
    <div class="alert alert-info">
      ‚ÑπÔ∏è Payment received. Student/Parent can now claim the items.
    </div>
    <div class="actions">
      <form method="post" action="{{ url_for('cashier.cashier_mark_claimed', reservation_id=header[0]) }}">
        <button class="btn btn-success" type="submit">üéâ Mark as CLAIMED</button>
      </form>
      <form method="post" action="{{ url_for('cashier.cashier_cancel_reservation', reservation_id=header[0]) }}">
        <button class="btn btn-danger" type="submit" onclick="return confirm('Cancel this reservation?')">‚ùå Cancel
          Reservation</button>
      </form>
    </div>

    {% elif header[7] == 'CLAIMED' %}
    <div class="alert alert-success">
      ‚úÖ Completed ‚Äî items have been claimed.
    </div>
    <div class="actions">
      <a href="{{ url_for('cashier.reservation_receipt', reservation_id=header[0]) }}" class="btn btn-primary"
        target="_blank">üñ®Ô∏è Print Receipt</a>
      <button class="btn btn-info" onclick="window.print()">üìÑ Print Page</button>
    </div>

    {% elif header[7] == 'CANCELLED' %}
    <div class="alert alert-warning">
      ‚ö†Ô∏è This reservation has been cancelled.
    </div>
    {% endif %}
  </div>

</div>
{% endblock %}