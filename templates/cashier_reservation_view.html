{% extends "base.html" %}

{% block title %}Reservation Details{% endblock %}

{% block styles %}
<style>
  * {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
  }

  body {
    background: #f5f7fa;
    color: #333;
  }

  .container {
    max-width: 900px;
    margin: 0 auto;
    padding: 20px;
  }

  header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 30px;
    padding-bottom: 20px;
    border-bottom: 2px solid #ddd;
  }

  h1 {
    font-size: 28px;
    color: #222;
  }

  .card {
    background: white;
    border-radius: 12px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.06);
    padding: 24px;
    margin-bottom: 20px;
  }

  .card h2 {
    font-size: 20px;
    margin-bottom: 16px;
    color: #222;
  }

  .card h3 {
    font-size: 16px;
    margin-bottom: 12px;
    color: #555;
  }

  .info-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 20px;
    margin-bottom: 16px;
  }

  .info-item {
    display: flex;
    flex-direction: column;
  }

  .info-label {
    font-size: 12px;
    color: #999;
    font-weight: 600;
    text-transform: uppercase;
    margin-bottom: 4px;
  }

  .info-value {
    font-size: 16px;
    color: #222;
    font-weight: 500;
  }

  .status-badge {
    display: inline-block;
    padding: 6px 14px;
    border-radius: 20px;
    font-size: 13px;
    font-weight: 600;
    width: fit-content;
  }

  .status-reserved {
    background: #fff3cd;
    color: #856404;
    border: 1px solid #ffeaa7;
  }

  .status-paid {
    background: #cfe2ff;
    color: #084298;
    border: 1px solid #b6d4fe;
  }

  .status-claimed {
    background: #d1e7dd;
    color: #0f5132;
    border: 1px solid #badbcc;
  }

  .status-cancelled {
    background: #f8d7da;
    color: #842029;
    border: 1px solid #f5c2c7;
  }

  .user-type-badge {
    display: inline-block;
    padding: 6px 12px;
    border-radius: 20px;
    font-size: 12px;
    font-weight: 600;
    margin-top: 4px;
  }

  .user-type-student {
    background: #e3f2fd;
    color: #1976d2;
    border: 1px solid #90caf9;
  }

  .user-type-parent {
    background: #f3e5f5;
    color: #7b1fa2;
    border: 1px solid #ce93d8;
  }

  .parent-info-box {
    background: #f3e5f5;
    border-left: 4px solid #7b1fa2;
    padding: 12px 16px;
    border-radius: 8px;
    margin-top: 16px;
    font-size: 13px;
  }

  .parent-info-box strong {
    color: #7b1fa2;
  }

  table {
    border-collapse: collapse;
    width: 100%;
    font-size: 14px;
    margin-top: 12px;
  }

  thead {
    background: #f8f9fa;
    border-bottom: 2px solid #ddd;
  }

  th {
    padding: 12px 16px;
    text-align: left;
    font-weight: 600;
    color: #555;
  }

  td {
    padding: 12px 16px;
    border-bottom: 1px solid #eee;
  }

  tbody tr:hover {
    background: #f9f9f9;
  }

  .total-row {
    background: #f8f9fa;
    font-weight: 600;
    border-top: 2px solid #ddd;
  }

  .total-row td {
    padding: 14px 16px;
  }

  .btn {
    padding: 10px 16px;
    border: 1px solid #ddd;
    border-radius: 8px;
    background: #f8f8f8;
    color: #222;
    cursor: pointer;
    font-size: 14px;
    font-weight: 500;
    transition: background 0.2s, box-shadow 0.2s;
    text-decoration: none;
    display: inline-block;
    border: none;
  }

  .btn:hover {
    background: #efefef;
    box-shadow: 0 2px 8px rgba(0,0,0,0.08);
  }

  .btn-primary {
    background: #007bff;
    color: white;
    border-color: #007bff;
  }

  .btn-primary:hover {
    background: #0056b3;
    box-shadow: 0 4px 12px rgba(0,123,255,0.3);
  }

  .btn-success {
    background: #28a745;
    color: white;
    border-color: #28a745;
  }

  .btn-success:hover {
    background: #218838;
    box-shadow: 0 4px 12px rgba(40,167,69,0.3);
  }

  .btn-danger {
    background: #dc3545;
    color: white;
    border-color: #dc3545;
  }

  .btn-danger:hover {
    background: #c82333;
    box-shadow: 0 4px 12px rgba(220,53,69,0.3);
  }

  .btn-info {
    background: #17a2b8;
    color: white;
    border-color: #17a2b8;
  }

  .btn-info:hover {
    background: #138496;
    box-shadow: 0 4px 12px rgba(23,162,184,0.3);
  }

  .actions {
    display: flex;
    gap: 12px;
    margin-top: 20px;
    flex-wrap: wrap;
  }

  form {
    display: inline;
  }

  .alert {
    padding: 12px 16px;
    border-radius: 8px;
    margin-bottom: 16px;
    font-size: 13px;
  }

  .alert-info {
    background: #d1ecf1;
    color: #0c5460;
    border: 1px solid #bee5eb;
  }

  .alert-success {
    background: #d4edda;
    color: #155724;
    border: 1px solid #c3e6cb;
  }

  @media (max-width: 600px) {
    .info-grid {
      grid-template-columns: 1fr;
    }

    .actions {
      flex-direction: column;
    }

    .actions form,
    .actions a {
      width: 100%;
    }

    .actions button,
    .actions .btn {
      width: 100%;
    }
  }

  @media print {
    body {
      background: white;
    }

    header .btn,
    .card:last-child {
      display: none !important;
    }

    .card {
      box-shadow: none;
      page-break-inside: avoid;
    }
  }
</style>
{% endblock %}

{% block content %}
<div class="container">
  <header>
    <h1>üìã Reservation Details</h1>
    <a href="{{ url_for('cashier.cashier_reservations') }}" class="btn">‚¨Ö Back to List</a>
  </header>

  {#
    UPDATED header indexes (from your new SQL):
    [0] = reservation_id
    [1] = student username
    [2] = student_user_id
    [3] = student_grade_level
    [4] = full_name (fallback = username)
    [5] = grade_level (fallback = student_grade_level)
    [6] = strand (NULL now)
    [7] = status
    [8] = created_at
    [9] = reserved_by_role (student/parent)
    [10] = parent_name (username)
    [11] = relationship (from parent_student)
  #}

  <!-- Reservation Header Info -->
  <div class="card">
    <h2>Reservation #{{ header[0] }}</h2>

    <div class="info-grid">
      <div class="info-item">
        <span class="info-label">Student ID</span>
        <span class="info-value">{{ header[1] }}</span>
      </div>

      <div class="info-item">
        <span class="info-label">Student Name</span>
        <span class="info-value">{{ header[4] or '-' }}</span>
      </div>

      <div class="info-item">
        <span class="info-label">Grade Level</span>
        <span class="info-value">{{ header[5] or header[3] or '-' }}</span>
      </div>

      <div class="info-item">
        <span class="info-label">Strand</span>
        <span class="info-value">{{ header[6] or '-' }}</span>
      </div>

      <div class="info-item">
        <span class="info-label">Reserved By</span>
        <span class="info-value">
          {% if header|length > 9 and header[9] == 'parent' %}
            <span class="user-type-badge user-type-parent">üë®‚Äçüë©‚Äçüëß Parent</span>
          {% else %}
            <span class="user-type-badge user-type-student">üë®‚Äçüéì Student</span>
          {% endif %}
        </span>
      </div>

      <div class="info-item">
        <span class="info-label">Status</span>
        <span class="status-badge status-{{ header[7]|lower }}">{{ header[7] }}</span>
      </div>

      <div class="info-item">
        <span class="info-label">Created Date</span>
        <span class="info-value">{{ header[8].strftime('%Y-%m-%d %H:%M') if header[8] else '-' }}</span>
      </div>
    </div>

    <!-- Parent Information (if reserved by parent) -->
    {% if header|length > 9 and header[9] == 'parent' %}
      <div class="parent-info-box">
        <strong>üë®‚Äçüë©‚Äçüëß Reserved by Parent:</strong><br>
        <div style="margin-top: 8px;">
          {% if header|length > 10 and header[10] %}
            <div><strong>Name:</strong> {{ header[10] }}</div>
          {% endif %}
          {% if header|length > 11 and header[11] %}
            <div><strong>Relationship:</strong> {{ header[11] }}</div>
          {% endif %}
        </div>
      </div>
    {% endif %}
  </div>

  <!-- Reserved Items -->
  <div class="card">
    <h3>üì¶ Reserved Items</h3>
    <table>
      <thead>
        <tr>
          <th>Item Name</th>
          <th>Quantity</th>
          <th>Size</th>
          <th>Unit Price</th>
          <th>Total</th>
        </tr>
      </thead>
      <tbody>
        {# items: [0]=item_name, [1]=qty, [2]=size_label, [3]=unit_price, [4]=line_total #}
        {% for it in items %}
        <tr>
          <td><strong>{{ it[0] }}</strong></td>
          <td style="text-align: center;">{{ it[1] }}</td>
          <td style="text-align: center;">
            {% if it[2] %}
              <span style="background: #f0f0f0; padding: 4px 8px; border-radius: 4px; font-size: 12px;">{{ it[2] }}</span>
            {% else %}
              <span style="color: #999;">-</span>
            {% endif %}
          </td>
          <td style="text-align: right;">‚Ç±{{ '%.2f'|format(it[3] or 0) }}</td>
          <td style="text-align: right;"><strong>‚Ç±{{ '%.2f'|format(it[4] or 0) }}</strong></td>
        </tr>
        {% endfor %}
        <tr class="total-row">
          <td colspan="4" style="text-align: right;">TOTAL:</td>
          <td style="text-align: right;">‚Ç±{{ '%.2f'|format(total or 0) }}</td>
        </tr>
      </tbody>
    </table>
  </div>

  <!-- Action Buttons -->
  <div class="card">
    <h3>Actions</h3>

    {% if header[7] == 'RESERVED' %}
      <div class="alert alert-info">
        ‚ÑπÔ∏è This reservation is still unpaid. Please collect payment and mark as PAID.
      </div>

      <div class="actions">
        <form method="post" action="{{ url_for('cashier.cashier_mark_paid', reservation_id=header[0]) }}">
          <button class="btn btn-success" type="submit">‚úÖ Mark as PAID</button>
        </form>

        <form method="post" action="{{ url_for('cashier.cashier_cancel_reservation', reservation_id=header[0]) }}">
          <button class="btn btn-danger" type="submit" onclick="return confirm('Are you sure you want to cancel this reservation?')">‚ùå Cancel Reservation</button>
        </form>
      </div>
    {% endif %}

    {% if header[7] == 'PAID' %}
      <div class="alert alert-info">
        ‚ÑπÔ∏è Payment received.
        {% if header|length > 9 and header[9] == 'parent' %}
          Parent/Student can now claim the items.
        {% else %}
          Student can now claim their items.
        {% endif %}
      </div>

      <div class="actions">
        <form method="post" action="{{ url_for('cashier.cashier_mark_claimed', reservation_id=header[0]) }}">
          <button class="btn btn-success" type="submit">üéâ Mark as CLAIMED</button>
        </form>

        <form method="post" action="{{ url_for('cashier.cashier_cancel_reservation', reservation_id=header[0]) }}">
          <button class="btn btn-danger" type="submit" onclick="return confirm('Are you sure you want to cancel this reservation?')">‚ùå Cancel Reservation</button>
        </form>
      </div>
    {% endif %}

    {% if header[7] == 'CLAIMED' %}
      <div class="alert alert-success">
        ‚úÖ This reservation has been completed and items were claimed.
      </div>

      <div class="actions">
        <a href="{{ url_for('cashier.reservation_receipt', reservation_id=header[0]) }}"
           class="btn btn-primary"
           target="_blank">
          üñ®Ô∏è Print Receipt
        </a>

        <button class="btn btn-info" onclick="window.print()">
          üìÑ Print This Page
        </button>
      </div>
    {% endif %}

    {% if header[7] == 'CANCELLED' %}
      <div class="alert alert-info">
        ‚ö†Ô∏è This reservation has been cancelled.
      </div>
    {% endif %}
  </div>
</div>
{% endblock %}